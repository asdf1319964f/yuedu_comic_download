## 项目说明书

### 功能概述

本项目是一个基于 Web 界面的通用下载工具，专注于从任务文件（`.txt` 或 `.json`）中解析图片链接并进行批量下载。它特别为漫画、图集等场景优化，提供多线程、代理支持、任务管理、打包压缩等一系列强大功能。

最新版本引入了 **Redis 缓存机制**，极大地提升了重复任务的处理效率，实现了智能跳过已下载内容的功能。

### 核心特性

1.  **Web 用户界面**：通过浏览器即可轻松上传任务、监控进度、管理任务，无需命令行操作。
2.  **多任务并行**：支持同时执行多个下载任务，互不干扰。
3.  **多线程下载**：可自定义每个任务的下载线程数，加快下载速度。
4.  **智能任务管理**：
    *   **任务持久化**：所有任务状态（等待、执行中、完成、失败等）都保存在 Redis 中，即使重启服务也不会丢失。
    *   **进度实时监控**：在网页上实时查看下载进度、速度和日志。
    *   **任务控制**：可以随时暂停、恢复正在执行的任务。
    *   **中断恢复**：服务器重启后，会自动将中断的任务标记为“中断”状态，方便后续处理。
5.  **智能跳过已下载内容 (v2.0 新增)**：
    *   **引入 Redis 缓存**：程序会利用 Redis 自动“记住”所有成功下载过的图片链接（URL）。
    *   **发现重复自动跳过**：当开始一个新任务或重试失败任务时，程序会先在 Redis 中检查每个图片的链接。如果发现该链接已被记录，则会**自动跳过**，不再进行重复下载，并会在日志中提示。
    *   **精确高效**：此机制不受本地文件名或图片顺序变化的影响，只要图片链接不变，就能精确识别，极大节省了时间和网络资源。
6.  **有序的本地文件**：
    *   **按数字序号排列**：为了方便本地阅读和管理，下载到本地的图片会严格按照它们在任务文件中出现的顺序，被重命名为 `0001.jpg`, `0002.jpg`, `0003.jpg`... 的格式。
    *   **章节文件夹**：图片会根据任务文件中的章节信息，自动存放在对应的章节文件夹内。
7.  **下载后处理**：
    *   **自动打包**：下载完成后，可选择将整个漫画/图集文件夹自动打包成一个 `.cbz` (zip) 文件，方便传输和阅读。
    *   **自动清理**：可选择在打包成功后，自动删除原始的图片文件夹，节省磁盘空间。
8.  **高级功能**：
    *   **代理支持**：支持配置 HTTP/HTTPS 代理列表，程序会随机选用进行下载。
    *   **自定义 Headers**：支持为请求添加自定义 `Cookie` 和 `Referer`。
    *   **AES 加密支持**：支持对下载的内容进行 AES 解密。
    *   **Rclone 集成**：提供将下载完成的文件一键上传到网盘（如 Google Drive, OneDrive）的功能。

### 环境要求

*   Python 3.7+
*   Redis 服务器
*   第三方库: `Flask`, `requests`, `pycryptodome`, `redis`

### 安装与启动

1.  **安装依赖**:
    ```bash
    pip install Flask requests pycryptodome redis
    ```

2.  **配置 Redis (可选但强烈推荐)**:
    *   确保您的 Redis 服务正在运行。
    *   打开 `app.py` 文件，根据您的实际情况修改顶部的 Redis 配置：
      ```python
      # --- Redis 配置 ---
      REDIS_HOST = 'localhost'
      REDIS_PORT = 6379
      REDIS_DB = 0
      ```
    *   如果 Redis 连接失败，程序仍可运行，但任务持久化和URL去重功能将不可用。

3.  **启动服务**:
    ```bash
    python app.py
    ```

4.  **访问界面**:
    *   服务启动后，打开浏览器访问 `http://127.0.0.1:5000` (或您服务器的IP地址加5000端口)。

### 使用方法

1.  **准备任务文件**：
    *   **`.txt` 格式**:
        ```
        # 这是一个示例
        书名：我的冒险
        作者：AI
        📌当前源站：⓪https://example.com/
        
        第一章：启程
        https://.../image01.jpg
        https://.../image02.jpg
        
        第二章：奇遇
        https://.../image03.jpg
        ```
    *   **`.json` 格式**: (更灵活，推荐)
        ```json
        {
          "title": "我的冒险",
          "author": "AI",
          "referer": "https://example.com/",
          "chapters": [
            {
              "title": "第一章：启程",
              "images": [
                {"url": "https://.../image01.jpg"},
                {"url": "https://.../image02.jpg"}
              ]
            },
            {
              "title": "第二章：奇遇",
              "images": [
                {"url": "https://.../image03.jpg"}
              ]
            }
          ]
        }
        ```

2.  **上传任务**:
    *   在网页上，点击“选择文件”，上传您的任务文件。
    *   根据需要填写 `Cookie`、`Referer`、代理列表等高级选项。
    *   设置下载线程数。
    *   选择是否在下载后打包和删除。
    *   点击“开始上传和下载”。

3.  **监控与管理**:
    *   任务提交后，页面会自动跳转到任务列表。
    *   您可以实时看到任务的进度条、日志，并进行暂停/恢复操作。
    *   下载/打包完成后，可以直接点击文件名进行下载，或使用 Rclone 上传。
