<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ¼«ç”»æ‰¹é‡ä¸‹è½½å™¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            --main-color: #4f8cff;
            --main-color-dark: #357ae8;
            --bg-color: #f4f7fa;
            --card-bg: #fff;
            --border-radius: 14px;
            --shadow: 0 4px 24px #0001;
            --text-color: #222;
            --sub-text: #888;
            --success: #4caf50;
            --fail: #e74c3c;
        }
        body {
            background: var(--bg-color);
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 480px;
            margin: 48px auto 0 auto;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 36px 32px 32px 32px;
            position: relative;
        }
        h1 {
            text-align: center;
            color: var(--main-color);
            font-size: 2.1em;
            margin-bottom: 18px;
            letter-spacing: 2px;
        }
        label {
            display: block;
            margin-top: 18px;
            font-weight: 600;
            color: var(--text-color);
        }
        input[type="file"], input[type="text"], input[type="number"], textarea {
            width: 100%;
            padding: 10px 12px;
            margin-top: 7px;
            border: 1.5px solid #e0e6ed;
            border-radius: 6px;
            font-size: 1em;
            background: #f8fafc;
            transition: border 0.2s;
        }
        input[type="file"] {
            background: #fff;
        }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
            border-color: var(--main-color);
            outline: none;
        }
        input[type="checkbox"] {
            margin-right: 7px;
            transform: scale(1.15);
        }
        button {
            margin-top: 28px;
            width: 100%;
            padding: 13px 0;
            background: linear-gradient(90deg, var(--main-color), var(--main-color-dark));
            color: #fff;
            border: none;
            border-radius: 7px;
            font-size: 1.15em;
            font-weight: 600;
            letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 0 2px 8px #4f8cff22;
            transition: background 0.2s, box-shadow 0.2s;
        }
        button:disabled {
            background: #b5c8e6;
            cursor: not-allowed;
            box-shadow: none;
        }
        .progress-bar {
            width: 100%;
            background: #e9eef5;
            border-radius: 6px;
            margin-top: 24px;
            height: 18px;
            box-shadow: 0 1px 4px #0001 inset;
            overflow: hidden;
        }
        .progress-bar-inner {
            height: 100%;
            background: linear-gradient(90deg, var(--main-color), var(--main-color-dark));
            border-radius: 6px;
            width: 0;
            transition: width 0.4s cubic-bezier(.4,2,.6,1);
        }
        .progress-text {
            margin-top: 10px;
            color: var(--main-color-dark);
            font-weight: 500;
            font-size: 1.05em;
            letter-spacing: 1px;
        }
        .log-box {
            background: #f8fafc;
            border: 1.5px solid #e0e6ed;
            border-radius: 6px;
            padding: 12px;
            margin-top: 18px;
            height: 110px;
            overflow-y: auto;
            font-size: 13px;
            color: #444;
            font-family: 'JetBrains Mono', 'Consolas', monospace;
        }
        .help-text {
            color: var(--sub-text);
            font-size: 12px;
            margin-top: 2px;
        }
        #downloadLink {
            margin-top: 22px;
            text-align: center;
        }
        #downloadLink a {
            display: inline-block;
            background: var(--success);
            color: #fff;
            padding: 8px 22px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            font-size: 1.08em;
            box-shadow: 0 2px 8px #4caf5022;
            transition: background 0.2s;
        }
        #downloadLink a:hover {
            background: #388e3c;
        }
        #rcloneUploadBox {
            display: none;
            margin-top: 28px;
            background: #f6faff;
            border-radius: 8px;
            padding: 18px 14px 10px 14px;
            border: 1.5px solid #e0e6ed;
        }
        #rcloneUploadBtn {
            margin-top: 10px;
            background: linear-gradient(90deg, #00b894, #00cec9);
            box-shadow: 0 2px 8px #00b89422;
        }
        #rcloneUploadBtn:disabled {
            background: #b2f7e2;
        }
        #rcloneProgressText {
            color: #00b894;
            font-weight: 500;
            margin-top: 8px;
        }
        .aes-config-bar {
            margin: 8px 0 0 0;
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .aes-config-bar select {
            width: 60%;
            padding: 6px 8px;
            border-radius: 5px;
            border: 1.2px solid #e0e6ed;
        }
        .aes-config-bar button {
            width: auto;
            margin-top: 0;
            padding: 6px 12px;
            font-size: 1em;
            box-shadow: none;
            background: #e0e6ed;
            color: #333;
            border-radius: 5px;
            border: none;
            transition: background 0.2s;
        }
        .aes-config-bar button:hover {
            background: #d0d8e6;
        }
        @media (max-width: 600px) {
            .container { max-width: 98vw; padding: 18px 4vw 18px 4vw; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ“š æ¼«ç”»æ‰¹é‡ä¸‹è½½å™¨</h1>
    <form id="uploadForm">
        <label for="taskfile">ä¸Šä¼ ä»»åŠ¡æ–‡ä»¶ (.txt æˆ– .json)</label>
        <input type="file" id="taskfile" name="taskfile" accept=".txt,.json" required>
        <div class="help-text">æ”¯æŒåŸå§‹æ¼«ç”»æºçš„ .txt æˆ– .json ä»»åŠ¡æ–‡ä»¶</div>

        <label for="cookie">Cookieï¼ˆå¯é€‰ï¼‰</label>
        <input type="text" id="cookie" name="cookie" placeholder="å¦‚éœ€ç™»å½•è¯·å¡«å†™">

        <!-- START: æ–°å¢çš„è‡ªå®šä¹‰Refererè¾“å…¥æ¡† -->
        <label for="customReferer">è‡ªå®šä¹‰Referer (å…¨å±€å¤‡ç”¨)</label>
        <input type="text" id="customReferer" name="custom_referer" placeholder="å¦‚éœ€æŒ‡å®šå…¨å±€Refererè¯·å¡«å†™">
        <div class="help-text">å½“ä»»åŠ¡æ–‡ä»¶å’Œå›¾ç‰‡é“¾æ¥æœ¬èº«éƒ½æœªæä¾›Refereræ—¶ï¼Œå°†ä½¿ç”¨æ­¤å€¼ã€‚</div>
        <!-- END: æ–°å¢éƒ¨åˆ† -->

        <label for="proxyList">ä»£ç†åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰</label>
        <textarea id="proxyList" name="proxy_list" rows="2" placeholder="æ¯è¡Œä¸€ä¸ªä»£ç†ï¼Œå¦‚ socks5://127.0.0.1:1080"></textarea>
        <div class="help-text">å¦‚éœ€ä½¿ç”¨ä»£ç†è¯·å¡«å†™ï¼Œæ”¯æŒ socks5/http/https</div>

        <label for="threadCount">ä¸‹è½½çº¿ç¨‹æ•°</label>
        <input type="number" id="threadCount" name="thread_count" min="1" max="32" value="4" />
        <div class="help-text">å»ºè®®4-8ï¼Œè¿‡é«˜å¯èƒ½è¢«å°IPæˆ–å½±å“æœåŠ¡å™¨æ€§èƒ½ã€‚</div>

        <label style="margin-top: 14px;">
            <input type="checkbox" id="packAfterDownload" name="pack_after_download" checked>
            ä¸‹è½½åè‡ªåŠ¨æ‰“åŒ…ä¸ºZIP
        </label>
        <label>
            <input type="checkbox" id="deleteAfterPack" name="delete_after_pack">
            æ‰“åŒ…ååˆ é™¤åŸæ–‡ä»¶å¤¹
        </label>

        <label for="aesKey">AESå¯†é’¥ (å¯é€‰)</label>
        <input type="text" id="aesKey" name="aes_key" placeholder="16å­—èŠ‚å­—ç¬¦ä¸²æˆ–32ä½hex">

        <label for="aesIv">AES IV (å¯é€‰)</label>
        <input type="text" id="aesIv" name="aes_iv" placeholder="16å­—èŠ‚å­—ç¬¦ä¸²æˆ–32ä½hex">

        <label for="aesName">å¯†é’¥åç§° (å¯é€‰)</label>
        <input type="text" id="aesName" name="aes_name" placeholder="å¦‚ï¼šç«™ç‚¹Aå¯†é’¥">

        <div class="aes-config-bar">
            <select id="aesConfigSelect">
                <option value="">é€‰æ‹©å·²ä¿å­˜çš„å¯†é’¥é…ç½®</option>
            </select>
            <button type="button" id="saveAesConfigBtn">ä¿å­˜å¯†é’¥</button>
            <button type="button" id="delAesConfigBtn">åˆ é™¤</button>
        </div>

        <button type="submit" id="submitBtn">ğŸš€ å¼€å§‹ä¸‹è½½</button>
        <button type="button" id="pauseBtn" style="margin-top:10px;display:none;">â¸ï¸ æš‚åœ</button>
        <button type="button" id="resumeBtn" style="margin-top:10px;display:none;">â–¶ï¸ ç»§ç»­</button>
    </form>

    <div class="progress-bar">
        <div class="progress-bar-inner" id="progressBar"></div>
    </div>
    <div class="progress-text" id="progressText"></div>
    <div class="log-box" id="logBox"></div>
    <div id="downloadLink"></div>

    <div id="rcloneUploadBox">
        <input type="text" id="remotePath" placeholder="rcloneè¿œç¨‹è·¯å¾„, å¦‚ gdrive:æ¼«ç”»å¤‡ä»½/" style="width:70%;padding:8px 10px;border-radius:5px;border:1.2px solid #e0e6ed;">
        <button id="rcloneUploadBtn" disabled>â˜ï¸ ä¸Šä¼ åˆ°ç½‘ç›˜</button>
        <div id="rcloneProgressText"></div>
        <div class="log-box" id="rcloneLogBox"></div>
    </div>
</div>

<script>
// JavaScriptéƒ¨åˆ†æ— éœ€ä»»ä½•ä¿®æ”¹ï¼Œå®ƒä¼šè‡ªåŠ¨æ”¶é›†æ–°æ·»åŠ çš„è¾“å…¥æ¡†æ•°æ®
const uploadForm = document.getElementById("uploadForm");
const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");
const logBox = document.getElementById("logBox");
const downloadLink = document.getElementById("downloadLink");
const submitBtn = document.getElementById("submitBtn");
const rcloneUploadBox = document.getElementById("rcloneUploadBox");
const rcloneUploadBtn = document.getElementById("rcloneUploadBtn");
const rcloneProgressText = document.getElementById("rcloneProgressText");
const rcloneLogBox = document.getElementById("rcloneLogBox");
const remotePathInput = document.getElementById("remotePath");
const pauseBtn = document.getElementById("pauseBtn");
const resumeBtn = document.getElementById("resumeBtn");

let pollingInterval = null;
let rclonePollingInterval = null;
let lastZipFile = null;
let currentTaskId = null;

// AESå¯†é’¥é…ç½®ç®¡ç†
function loadAesConfigs() {
    let configs = JSON.parse(localStorage.getItem("aesConfigs") || "[]");
    return configs;
}
function saveAesConfigs(configs) {
    localStorage.setItem("aesConfigs", JSON.stringify(configs));
}
function refreshAesConfigSelect() {
    const select = document.getElementById("aesConfigSelect");
    const configs = loadAesConfigs();
    select.innerHTML = '<option value="">é€‰æ‹©å·²ä¿å­˜çš„å¯†é’¥é…ç½®</option>';
    configs.forEach((cfg, idx) => {
        let label = cfg.name ? cfg.name : `å¯†é’¥${idx+1}`;
        select.innerHTML += `<option value="${idx}">${label} (${cfg.key.slice(0,6)}...)</option>`;
    });
}
document.getElementById("saveAesConfigBtn").onclick = function() {
    const key = document.getElementById("aesKey").value.trim();
    const iv = document.getElementById("aesIv").value.trim();
    const name = document.getElementById("aesName").value.trim();
    if (!key || !iv) { alert("è¯·å¡«å†™å¯†é’¥å’ŒIV"); return; }
    let configs = loadAesConfigs();
    configs.push({name, key, iv});
    saveAesConfigs(configs);
    refreshAesConfigSelect();
    alert("å·²ä¿å­˜ï¼");
};
document.getElementById("delAesConfigBtn").onclick = function() {
    const select = document.getElementById("aesConfigSelect");
    if (!select.value) { alert("è¯·é€‰æ‹©è¦åˆ é™¤çš„é…ç½®"); return; }
    let configs = loadAesConfigs();
    configs.splice(Number(select.value), 1);
    saveAesConfigs(configs);
    refreshAesConfigSelect();
};
document.getElementById("aesConfigSelect").onchange = function() {
    const idx = this.value;
    if (!idx) return;
    let configs = loadAesConfigs();
    let cfg = configs[Number(idx)];
    if (cfg) {
        document.getElementById("aesKey").value = cfg.key;
        document.getElementById("aesIv").value = cfg.iv;
        document.getElementById("aesName").value = cfg.name || "";
    }
};
refreshAesConfigSelect();

uploadForm.addEventListener("submit", function(e) {
    e.preventDefault();
    submitBtn.disabled = true;
    pauseBtn.style.display = "inline-block";
    resumeBtn.style.display = "none";
    pauseBtn.disabled = false;
    resumeBtn.disabled = false;
    progressBar.style.width = "0";
    progressText.textContent = "";
    logBox.textContent = "";
    downloadLink.innerHTML = "";
    rcloneUploadBox.style.display = "none";
    rcloneUploadBtn.disabled = true;
    rcloneProgressText.textContent = "";
    rcloneLogBox.textContent = "";
    lastZipFile = null;

    const formData = new FormData(uploadForm); // ä½¿ç”¨ new FormData(formElement) æ›´ç®€æ´
    const fileInput = document.getElementById("taskfile");
    if (!fileInput.files.length) {
        alert("è¯·é€‰æ‹©ä»»åŠ¡æ–‡ä»¶ï¼");
        submitBtn.disabled = false;
        pauseBtn.style.display = "none";
        resumeBtn.style.display = "none";
        return;
    }
   
    fetch("/upload", {
        method: "POST",
        body: formData
    }).then(res => res.json()).then(data => {
        if (data.error) {
            alert(data.error);
            submitBtn.disabled = false;
            pauseBtn.style.display = "none";
            resumeBtn.style.display = "none";
            return;
        }
        currentTaskId = data.task_id;
        pollStatus(data.task_id);
    }).catch(err => {
        alert("ä¸Šä¼ å¤±è´¥: " + err);
        submitBtn.disabled = false;
        pauseBtn.style.display = "none";
        resumeBtn.style.display = "none";
    });
});

pauseBtn.onclick = function() {
    if (!currentTaskId) return;
    pauseBtn.disabled = true;
    fetch("/pause/" + currentTaskId, {method: "POST"})
        .then(res => res.json())
        .then(data => {
            if (data.status === "paused") {
                pauseBtn.style.display = "none";
                resumeBtn.style.display = "inline-block";
            } else {
                pauseBtn.disabled = false;
            }
        });
};
resumeBtn.onclick = function() {
    if (!currentTaskId) return;
    resumeBtn.disabled = true;
    fetch("/resume/" + currentTaskId, {method: "POST"})
        .then(res => res.json())
        .then(data => {
            if (data.status === "resumed") {
                resumeBtn.style.display = "none";
                pauseBtn.style.display = "inline-block";
            } else {
                resumeBtn.disabled = false;
            }
        });
};

function pollStatus(taskId) {
    pollingInterval = setInterval(() => {
        fetch("/status/" + taskId).then(res => res.json()).then(data => {
            if (data.error) {
                progressText.textContent = data.error;
                clearInterval(pollingInterval);
                submitBtn.disabled = false;
                pauseBtn.style.display = "none";
                resumeBtn.style.display = "none";
                return;
            }
            progressBar.style.width = (data.progress_percent || 0) + "%";
            progressText.textContent = `è¿›åº¦: ${data.progress_current}/${data.progress_total} (${Math.round(data.progress_percent)}%) çŠ¶æ€: ${data.status}`;
            logBox.textContent = (data.logs || []).slice(-10).join("\n");
            logBox.scrollTop = logBox.scrollHeight;
            if (data.status === "å®Œæˆ" && data.result && data.result[0] && data.result[0].zip) {
                lastZipFile = data.result[0].zip;
                downloadLink.innerHTML = `<a href="/download/${encodeURIComponent(data.result[0].zip)}" target="_blank">ğŸ“¦ ä¸‹è½½ZIPåŒ…</a>`;
                rcloneUploadBox.style.display = "block";
                rcloneUploadBtn.disabled = false;
                clearInterval(pollingInterval);
                submitBtn.disabled = false;
                pauseBtn.style.display = "none";
                resumeBtn.style.display = "none";
            } else if (["å¤±è´¥", "ä¸­æ–­"].includes(data.status)) {
                clearInterval(pollingInterval);
                submitBtn.disabled = false;
                pauseBtn.style.display = "none";
                resumeBtn.style.display = "none";
            } else if (data.status === "æ‰§è¡Œä¸­") {
                pauseBtn.style.display = "inline-block";
                resumeBtn.style.display = "none";
                pauseBtn.disabled = false;
                resumeBtn.disabled = false;
            } else if (data.status === "æš‚åœä¸­") {
                pauseBtn.style.display = "none";
                resumeBtn.style.display = "inline-block";
                pauseBtn.disabled = false;
                resumeBtn.disabled = false;
            }
        });
    }, 1500);
}

rcloneUploadBtn.onclick = function() {
    if (!lastZipFile) { alert("è¯·å…ˆä¸‹è½½å®Œæˆ"); return; }
    const remotePath = remotePathInput.value;
    if (!remotePath) { alert("è¯·å¡«å†™rcloneè¿œç¨‹è·¯å¾„"); return; }
    rcloneUploadBtn.disabled = true;
    rcloneProgressText.textContent = "æ­£åœ¨ä¸Šä¼ ...";
    rcloneLogBox.textContent = "";
    fetch("/rclone_upload", {
        method: "POST",
        body: new URLSearchParams({
            filename: lastZipFile,
            remote_path: remotePath
        })
    }).then(res => res.json()).then(rdata => {
        if (rdata.error) { alert(rdata.error); rcloneUploadBtn.disabled = false; return; }
        pollRcloneStatus(rdata.task_id);
    });
};

function pollRcloneStatus(taskId) {
    rclonePollingInterval = setInterval(() => {
        fetch("/rclone_status/" + taskId).then(res => res.json()).then(data => {
            if (data.error) {
                rcloneProgressText.textContent = data.error;
                clearInterval(rclonePollingInterval);
                rcloneUploadBtn.disabled = false;
                return;
            }
            rcloneProgressText.textContent = `çŠ¶æ€: ${data.status}`;
            rcloneLogBox.textContent = (data.logs || []).slice(-10).join("\n");
            rcloneLogBox.scrollTop = rcloneLogBox.scrollHeight;
            if (data.status === "å®Œæˆ" || data.status === "å¤±è´¥") {
                clearInterval(rclonePollingInterval);
                rcloneUploadBtn.disabled = false;
            }
        });
    }, 1500);
}
</script>
</body>
</html>
